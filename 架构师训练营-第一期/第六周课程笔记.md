# 第六周课程笔记

**清楚辨知烦恼的缘起，面对它、接受它、处理它、放下下。**



### 分布式数据库

#### MySQL数据库

高性能数据库集群的第一种方式是“读写分离”，其本质是将访问压力分散到集群中的多个节点，但是没有分散存储压力；第二种方式是“分库分表”，既可以分散访问压力，又可以分散存储压力。

**读写分离**

**分库分表**

##### 读写分离

单一数据库 -> 主从复制（一主一从、一主多从） -> 主主复制

为提供读的高可用，引入主从复制，从只负责读。

为了提高写的高可用，通过主主复制来实现。

**一主多从复制的优点**
分摊负载
专机专用
便于冷备
高可用

**MySQL 复制注意事项：**
**主主复制的两个数据库不能并发写入**。
复制只是增加了数据的读并发处理能力，没有增加写并发能力和存储能力。
更新表结构会导致巨大的同步延迟。



读写分离的实现逻辑并不复杂，但有两个细节点将引入设计复杂度：**主从复制延迟和分配机制。**

解决主从复制延迟有几种常见的方法：
1. 写操作后的读操作指定发给数据库主服务器
2. 读从机失败后再读一次主机这就是通常所说的“二次读取”，二次读取和业务无绑定。
3. 关键业务读写操作全部指向主机，非关键业务采用读写分离.

将读写操作区分开来，然后访问不同的数据库服务器，一般有两种方式：程序代码封装和中间件封装。



##### 分片分表

**数据分片的方法：**

硬编码实现数据分片
映射表外部存储

**数据分片的挑战**
需要大量的额外代码，处理逻辑因此变得更加复杂。
无法执行多分片的联合查询。
无法使用数据库的事务。
随着数据的增长，如何增加更多的服务器。



**常见的分散存储的方法“分库分表”，其中包括“分库”和“分表”两大类。**

业务分库业务分库指的是按照业务模块将数据分散到不同的数据库服务器。

单表数据拆分有两种方式：垂直分表和水平分表。



#### CAP原理

**C：Consistency**

即一致性，访问所有的节点得到的数据应该是一样的。**注意**，这里的一致性指的是强一致性，也就是数据更新完，访问任何节点看到的数据完全一致，要和弱一致性，最终一致性区分开来。

**A：Availability**

即可用性，所有的节点都保持高可用性。**注意**，这里的高可用还包括不能出现延迟，比如如果节点B由于等待数据同步而阻塞请求，那么节点B就不满足高可用性。

也就是说，任何没有发生故障的服务必须在有限的时间内返回合理的结果集。

**P：Partiton tolerence**

即分区容忍性，这里的分区是指网络意义上的分区。由于网络是不可靠的，所有节点之间很可能出现无法通讯的情况，在节点不能通信时，要保证系统可以继续正常服务。



**由于网络的不可靠性质，大多数开源的分布式系统都会实现P，也就是分区容忍性，之后在C和A中做抉择。**

关于CAP 原理，更准确的说法是，在分布式系统必须要满足分区耐受性的前提下，可用性和一致性无法同时满足。

#### NoSQL



##### ACID

原子性（Atomicity）: 事务要么全部完成，要么全部取消。如果事务崩溃，状态回到事务之前（事务回滚）。
隔离性（Isolation）: 如果2个事务T1 和T2 同时运行，事务T1 和T2 最终的结果是相同的，不管T1和T2谁先结束，隔离性主要依靠锁实现。
持久性（Durability）: 一旦事务提交，不管发生什么（崩溃或者出错），数据要保存在数据库中。
一致性（Consistency）: 只有合法的数据（依照关系约束和函数约束）才能写入数据库。

##### BASE

Basically Available（基本可用）系统在出现不可预知故障时，允许损失部分可用性，如响应时间上的损失或功能上的损失。
Soft state（弱状态）软状态，指允许系统中的数据存在中间状态，并认为该中间状态的存在不会影响系统的整体可用性，即允许系统在不同节点的数据副本之间进行数据同步的过程存在延时。
Eventually consistent（最终一致性）指系统中所有的数据副本，在经过一段时间的同步后，最终能够达到一个一致的状态，因此最终一致性的本质是需要系统保证数据能够达到一致，而不需要实时保证系统数据的强一致性。



### 分布式一致ZooKeeper

#### 概述

ZooKeeper没有采用Paxos算法，而是采用了一种被称为ZAB的一致性协议。 
ZooKeeper是一个分布式协调服务。

设计目标是将那些复杂的分布式一致性服务封装起来，以接口的形式提供给用户使用。

ZooKeeper是一个分布式数据一致性的解决方案，分布式应用程序可以基于它实现诸如数据发布/订阅，分布式锁，Master选举等功能。

ZooKeeper作为一个分布式协调框架，主要用于解决分布式数据一致性的问题。



#### API

String create(path, data, acl, flags)
void delete(path, expectedVersion)
Stat setData(path, data, expectedVersion)
(data, Stat) getData(path, watch)
Stat exists(path, watch)
String[] getChildren(path, watch)
void sync(path)
List multi(ops)



#### 用途

配置管理（数据发布/订阅）：

　　两种模式：推模式和拉模式。

　　　　推模式：服务端主动将数据更新发送给所有订阅的客户端。

　　　　拉模式：客户端主动发起请求来获取最新数据。


Master选举：

　　利用ZooKeeper的强一致性，能够保证在分布式高并发环境下节点的创建是全局唯一的。

集群管理（负载均衡与失效转移），心跳检测机制：

　　可以让不同的机器都在ZooKeeper的一个指定节点下创建临时子节点。不同机器之间可以根据这个临时节点来判断对应的客户端机器是否存活。

 分布式锁：

　　分布式锁是控制分布式系统之间同步访问共享资源的一种方式。



### **参考**

大型网站技术架构-李智慧

极客时间 从0开始学架构 -- 高性能数据库集群

CAP原理

https://www.jianshu.com/p/482ba491a760