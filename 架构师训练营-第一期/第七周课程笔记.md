# 第七周课程笔记

**编码能力很重要，但是技术视野、技术洞察力，以及我们如何用技术解决问题的能力更为重要。**



## 性能测试

性能测试是性能优化的前提和基础，也是性能优化结果的检查和度量标准。不同视角下的网站性能有不同的标准，也有不同的优化手段。

- 主观视角：用户感受到的性能。
  （支付转账场景，用户点击转账后，有个倒计时的页面，即时反馈给用户，让用户感受到快。）
- 客观视角：性能指标衡量的性能。

## 性能测试指标

不同视角下有不同的性能标准，不同的标准有不同的性能测试指标，网站性能测试的主要指标有响应时间、并发数、吞吐量、性能计数器等。

### 响应时间

响应时间：指应用系统从发出请求开始到收到最后响应数据所需要的时间。响应时间是系统最重要的性能指标，直观的反映了系统的“快慢”。

### 并发数

并发数：系统能够同时处理请求的数目，这个数字也反映了系统的负载特性。对于网站而言，并发数即系统并发用户数，指同时提交请求的用户数目，于此相对应，还有在线用户数（当前登录系统的用户数）和系统用户数（可能访问系统的总用户数）。

### 吞吐量

吞吐量：指单位时间内系统处理的请求的数量，体现系统的处理能力。对于网站，可以用 “请求数/秒” 或是 “页面数/秒” 来衡量，也可以用 “访问人数/天” 或是 “处理的业务数/小时” 等来衡量。

- TPS(每秒事务数)也是吞吐量的一个指标，此外还有HPS（每秒HTTP请求数）。
- QPS(每秒查询数)。

> 吞吐量 = (1000 / 响应时间ms) * 并发数



## 性能测试方法

性能测试是一个总称，具体可细分为性能测试、负载测试、压力测试、稳定性测试。

### 性能测试

以系统设计初期规划的性能指标为预期目标，对系统不断施加压力，验证系统在资源可接收范围内，是否能达到性能预期。

### 负载测试

对系统不断地增加并发请求以增加系统压力，直到系统的某项或多项性能指标达成安全临界值，如某种资源已经呈饱和状态，这时候继续对系统施加压力，系统的处理能力不但不能提高，反而会下降。

### 压力测试

超过安全负载的情况下，对系统继续施加压力，知道系统崩溃或不能再处理任何请求，以获得系统最大压力承受能力。

### 稳定性测试

被测试系统在特定硬件、软件、网络环境条件下，给系统加载一定业务压力，使系统运行一段较长时间，以此检测系统是否稳定。在生产环境，请求压力是不均匀的，呈波浪特性，因此为了更好地模拟生产环境，稳定性测试也应不均匀地对系统施加压力。

## 软件性能优化的两个基本原则

- 你不能优化一个没有测试的软件。
- 你不能优化一个你不了解的软件。



## 性能测试的主要指标

- 响应时间：完成一次任务花费的时间。
- 并发数：同时处理的任务数。
- 吞吐量：单位时间完成的任务数。
- 性能计数器：System Load, 线程数，进程数，CPU，内存，磁盘，网络使用率。



## 性能优化的一般方法

- 性能测试，获得性能指标。
- 指标分析，发现性能与资源瓶颈点。
- 架构与代码分析，寻找性能与资源瓶颈关键所在。
- 架构与代码优化，优化关键技术点，平衡资源利用。
- 性能测试，进入性能优化闭环。

## 系统性能优化的分层思想

- 机房与骨干网络性能优化。
- 服务器与硬件性能优化。（垂直伸缩）
- 操作系统性能优化。
- 虚拟机性能优化。（垃圾回收性能优化，锁对性能的优化）
- 基础组件性能优化
- 软件架构性能优化
- 软件代码性能优化

## 软件架构性能优化三板斧

- 缓存
- 异步
- 集群

### 缓存

- 从内存获取数据，减少响应时间。
- 减少数据库访问，降低存储设备负载压力。
- 缓存结果对象，而不是原始数据，减少 CPU 计算。
- 缓存主要优化读操作。

### 异步

- 即时响应，更好的用户体验。
- 控制消费速度，合适的负载压力。
- 异步主要优化写操作。

### 集群

古老谚语：如果一匹马拉不动车，无需换一匹更强的马，而是用两匹马拉车。
互联网技术的发展路径是：更多的用户访问需要消耗更多的计算机资源，单一服务器计算资源的增加是有极限的，所以需要增加更多的服务器。关键是如何利用起来这些服务器。
集群的技术目标只有一个：如何使很多台服务器对使用者而言看起来像一台服务器。



## 软件代码性能优化

遵循面向对象的设计原则与设计模式编程，很多时候程序性能不好不是因为性能上有什么技术挑战，仅仅就是因为代码太烂了。

- 并发编程，多线程与锁。
- 资源复用，线程池与对象池。
- 异步编程，生产者与消费者。
- 数据结构，数组、链表、hash表、树。



## 参考

大型网站技术架构-李智慧

